---
title: "Dmel Social Environment on Behaviour"
author: "Erin Macartney"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
      code_folding: hide
      toc_depth: 3
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r, message = F}
library(tidyverse)
library(lme4)
library(lmerTest)
library(here) # write out the path
library(kableExtra)
library(sjlabelled)
library(ggpubr)
library(rstatix)
library(car)
library(RColorBrewer)
library(readxl)
library(patchwork)
library(car)
```

## Loading data
Loading session data with treatments and sex etc

```{r 1_data_load}
#Loading in session data
Session_data <- read_excel(here("Data/session_data/Session_data_extended.xlsx"))
data_locomotion <- read.csv(here("Data/data_locomotion.csv"))
data_ymaze <- read.csv(here("Data/data_ymaze.csv")) #not that this still has the 15th ymaze included in dataset but this is removed through na.omit later

data_startle_act <- read.csv(here("Data/data_startle_act.csv")) #no startles removed
data_startle <- read.csv(here("Data/data_startle.csv")) 


Session_data$Individual_ID <- paste(Session_data$Assay_ID,Session_data$Position, sep = "_")
```

## Data processing {.tabset}

### Locomotion

```{r 2_data_load, eval = FALSE}
data_path <- here("Data/locomotion/")
data_files <- list.files(here("Data/locomotion/"), recursive = T)

#This loads all 24 files but we will only parse one data file for now
data_files[1:24]
```

```{r 3_new_data_compiler, eval = FALSE}
data_compiler <- function(filename, data_path) {
  
  ## ARG filename vector or list of file names to process (only files, no full paths)
  ## ARG data_path text string with the path to access all files
  ## ARG run_register database of all runs with datafile IDs and sexing IDs
  
  ## ARGS to develop: passing custom RE, custom wells to skip, custom columns to skip
  
  dat_temp <- readLines(paste(data_path, filename, sep = '/'))
  
  # file parsing
  dat_temp_df <- read.csv(text = dat_temp, header = T, sep = ',',
                          quote = '\"', dec = '.', skip = 4, nrows = length(dat_temp) - 4 - 2,
                          stringsAsFactors = F)
  
  ## these line are design specific - for now the function has close form on those
  ## possible to implement as additional argument
  
  dat_temp_df <- dat_temp_df[, -(2:6)]
  dat_temp_df <- dat_temp_df %>% select(!(F3:F8))
  
  # extract headers
  head_temp <- readLines(paste(data_path, filename, sep = '/'), n = 4)
  
  # using RE - this method is more flexible as the structure and location of ID can change
  id_index <- grep('Subject Identification', head_temp)
  run_id <- gsub('.*Subject Identification\\\",\"([A-Z]{1}[0-9]{3})\\\"', '\\1', head_temp[id_index])
  dat_temp_df$Datafile_ID <- run_id
  
  # assay_date <- str_sub(run_id, 11, 16)
  # dat_temp_df$date <- assay_date
  
  dat_temp_df <-
  dat_temp_df %>%
  pivot_longer(names_to = 'well_id', values_to = 'arena_distance', cols = matches('[A-H][1-9]')) %>%
  rename(time = TIME, temperature = TEMPERATURE, round = ROUND,
         variable = VARIABLE)
  
  dat_temp_df$Individual_ID <- paste(dat_temp_df$Datafile_ID, dat_temp_df$well_id, sep = "_")
  
  # dat_temp_df <- dat_temp_df %>%
  #   left_join(select(run_register, Datafile_ID, Individuals_ID, Exp_block, Batch_ID))
  # 
  # dat_temp_df <- dat_temp_df %>%
  #   mutate(Individuals_ID_well = paste0(Individuals_ID, '_', Well_ID))
  # 
  # dat_temp_df$Filename <- filename
  
  dat_temp_df <- dat_temp_df %>% select(Individual_ID, Datafile_ID,
                                      temperature, round, arena_distance)

  return(dat_temp_df)
}
```


```{r 4_parse_data, message = F, eval = FALSE}
# Not run: test
# data_compiler(data_files[1], data_path, run_register)

data_locomotion <- map_dfr(data_files, ~ data_compiler(.x, data_path = data_path))

length(unique(data_locomotion$Datafile_ID)) # should be 8 distinct files

glimpse(data_locomotion)
```

```{r 5_merge_alrge_data_with_session_data, eval = FALSE}
# data_locomotion$Individual_ID <- paste(data_locomotion$Datafile_ID, data_locomotion$well_id, sep = "_")


data_locomotion  <- data_locomotion%>%
  left_join(Session_data, by = "Individual_ID")

write.table(data_locomotion, file = "./Data/data_locomotion.csv", sep = ",", row.names = F)
```


```{r 6_forloop, eval = FALSE}
# files <- list.files(data_path)
# locomotion_full <- NULL
# for(i in 1:length(files)){
#   temp <- read.csv(text = dat_temp, 
#                    header = T, 
#                    sep = ',',
#                    quote = '\"', 
#                    dec = '.', 
#                    skip = 4, 
#                    nrows = length(dat_temp) - 4 - 2,
#                    stringsAsFactors = F)
#   dat_temp_df <- temp[,-(2:6)] # remove spurious columns
#   head_temp <-
#     readLines(paste(data_path, data_files[1], sep = '/'), n = 4)
#   id_index <- grep('Subject Identification', head_temp)
#   run_id <-
#     gsub('.*Subject Identification\\\",\"([A-Z]{1}[0-9]{3})\\\"',
#          '\\1',
#          head_temp[id_index])
#   dat_temp_df$Datafile_ID <- run_id
#   dat_temp_df2 <-
#     dat_temp_df %>%
#     pivot_longer(
#       names_to = 'well_id',
#       values_to = 'arena_distance',
#       cols = matches('[A-H][1-9]')
#     ) %>%
#     rename(
#       time = TIME,
#       temperature = TEMPERATURE,
#       round = ROUND,
#       variable = VARIABLE
#     )
#   locomotion_full <- bind_rows(locomotion_full, dat_temp_df2)
# }
```

```{r 7_joining session data, eval = FALSE}
# Session_data$Individual_ID <- paste(Session_data$Assay_ID,Session_data$Position, sep = "_")
# 
# locomotion_full$Individual_ID <- paste(locomotion_full$Datafile_ID, locomotion_full$well_id, sep = "_")
# 
# 
# locomotion_full  <- locomotion_full %>%
#   left_join(Session_data, by = "Individual_ID")
```

### Ymaze
```{r 8_load_data, eval = FALSE}
#First we load the y-maze data and tidy it up to separate summary data from zone changes data.
## parse datafiles into a nested tibble
data_path <- here('Data/ymaze/')
data_files <- list.files(here('Data/ymaze/'), recursive = T)
data_files[1:72]
```

```{r 9_create_parser, eval = FALSE}
#The below parser identifies lines in the dataset that directly relate to zone-switching data and extracts them, or (when `summary = TRUE`) it extracts the arena distances summaries from the bottom section of the file.

#[EDIT] apparently read_delim no longer works with just vectors, now needs `I()`*

# helper functions extracting the data rows and the header rows
data_parser <- function(pattern, path, filename, summary = FALSE) {
  dat_temp <- readLines(paste(path, filename, sep = '/'))
  zone_change_index <- grep(pattern, dat_temp)
  
  if(summary == FALSE) {
    return(read_delim(file = I(dat_temp[zone_change_index]), col_names = F, delim = ',',
                      quote = '\"' # skip = 4, nrows = length(dat_temp) - 4 - 1)
    ))
  } else {
    return(read_delim(file = I(dat_temp[-zone_change_index]), col_names = T, delim = ',',
                      quote = '\"', skip = 6, n_max = 3))
  }
}

# test the parser
# here we simply check that the selected pattern to be looked for (`Arena`) is indeed present in the file.
pattern1 <- "Arena" # defines what should contain each line that we look for
test1 <- readLines(paste(data_path, data_files[1], sep = '/'))
id_test <- grep(pattern1, test1) # use (simplified) RE to select lines
```

```{r 10_test_data, eval = FALSE}

# [EDIT] apparently read_delim no longer works with just vectors, now needs `I()`
# this extracts (messy) run and temporary data from each file
test_dat <- read_delim(file = I(test1[-id_test]), col_names = T, delim = ',',
                      quote = '\"', skip = 6, n_max = 3)

# helper function that parses the (messy) run data into a readable format)
head_parser <- function(path, filename) {
  dat_temp <- readLines(paste(path, filename, sep = '/'), n = 4)
  return(read_delim(file = I(dat_temp),
                    delim = ',',
                    col_names = F))
}
```

```{r 11_parse_data_into_tibbles, eval = FALSE}
# create tibble with raw data (nested: data and header nested under file names)
dat_raw <- tibble(data_files = data_files) %>%
  mutate(data = map(data_files, 
                    ~ data_parser(pattern1,
                                  data_path,
                                  .x, summary = FALSE))) %>%
  mutate(head = map(data_files, ~ head_parser(data_path, .x)))

# this removes the redundant 'Arena' column
dat_raw[[2]] <- dat_raw[[2]] %>%
  map(~ select(.x, !c(X3)))

# rename variables in sub-tibble based on their real content
dat_raw[[2]] <- dat_raw[[2]] %>%
  map(~ rename(.x, time = X1, Info = X2, Arena = X4, Action = X5, Zone_no = X6))

# reformat the head sub-tibble
dat_raw[[3]] <- dat_raw[[3]] %>%
  map(~ pivot_wider(.x, names_from = X3, values_from = X4)) %>%
  map(~ rename(.x, Datafile_ID = `Subject Identification`)) %>%
  map(~ select(.x, Apparatus, Datafile_ID))

# check the modifications
dat_raw[[2]][[1]]
dat_raw[[3]][[1]]
```

```{r 12_process_summaries, eval = FALSE}

# Below code is used to  extract and organise arena summaries - this data is not very useful as it only represents time/distance totals in each of an arena's zones.
# parse summary data from a file into a separate tibble - this is not used for now
# processed only for consistency
dat_raw_summ <- tibble(data_files = data_files) %>%
  mutate(data = map(data_files, ~ data_parser(pattern1,
                                data_path,
                                .x,
                                summary = T)))
dat_raw_summ[[2]] <- dat_raw_summ[[2]] %>%
  map(~ select(.x, !c(...1, ...2, ...3))) %>%
  map(~ rename(.x, Summary_stat = ...4))
dat_raw_summ[[2]][[1]]
```

```{r 13_unnest, eval = FALSE}

dat_un <- dat_raw %>%
  unnest(head) %>%
  unnest(data)

dat_un <- dat_un %>%
  select(data_files, Datafile_ID, time, Arena, Action, Zone_no) %>%
  rename(Data_file = data_files)

```

```{r 14_turn_towide, eval = FALSE}
dat_un <- dat_un %>%
  mutate(Row_ID = row_number()) %>%
  pivot_wider(names_from = Action, values_from = Zone_no) %>%
  rename(Exit_zone = Exit_Zone, Enter_zone = Enter_Zone)
dat_un
```

```{r 15_create_time_bins, eval = FALSE}
dat_an <- dat_un
dat_an <- dat_an %>%
  mutate(Bin = ifelse(time > 600 & time < 1200, 1,
                      ifelse(time > 1200 & time < 1800, 2,
                             ifelse(time > 1800 & time < 2500, 3, NA))))

dat_an <- dat_an %>%
  arrange(Data_file, Datafile_ID, Arena, time, Exit_zone)
dat_an
```

```{r 16_error_check_create_exit_entry_instances, eval = FALSE}
dat_an <- dat_an %>%
  mutate(Zone = ifelse(Enter_zone == lead(Exit_zone), Enter_zone, 666)) %>%
  mutate(t_enter = ifelse(Enter_zone >= 1, time, 666)) %>%
  mutate(t_exit = ifelse(Exit_zone >= 1, time, 666))

dat_an %>% filter(Zone == 666)
dat_an %>% filter(t_enter == 666)
dat_an %>% filter(t_exit == 666)

# ALL GOOD! Note - this step is very important and serves to test if data points were sorted correctly
# Single detected mistakes are likely final entries that failed to exit before assay end


# Let's filter out the non-conforming cases and re-confirm the rest is ordered correctly
# This stage is critical: dplyr filter() function is terribly unintuitive - with the logical
# condition "NOT" (!) it also drops NA values - thus we have to ensure with replace_na() they are kept
# to preserve the ordering of enter-exit events

dat_an <- dat_an %>% filter((Zone != 666) %>% replace_na(TRUE))
dat_an <- dat_an %>%
  arrange(Data_file, Datafile_ID, Arena, time, Exit_zone)
dat_an <- dat_an %>%
  mutate(Zone = ifelse(Enter_zone == lead(Exit_zone), Enter_zone, 666)) %>%
  mutate(t_enter = ifelse(Enter_zone >= 1, time, 666)) %>%
  mutate(t_exit = ifelse(Exit_zone >= 1, time, 666))
dat_an %>% filter(Zone == 666)
# repeat above 4 steps until last line of code returns empty tibble
```

```{r 17_calculate_zone_times, eval = FALSE}
dat_an <- dat_an %>%
  # filter(is.na(Zone)) %>% # this filter is just for testing purposes (it removes the 'Exit_zone' portion of data)
  select(Data_file, Datafile_ID, time, Arena, Row_ID, Bin, Zone, t_enter, t_exit)
dat_an <- dat_an %>%
  mutate(t_exit = lead(t_exit))
dat_an <- na.omit(dat_an)
dat_an <- dat_an %>%
  mutate(t_zone = t_exit - t_enter)
dat_an
```

```{r 18_remove_central_zone, eval = FALSE}
dat_an2 <- dat_an %>% filter(Zone != 4)
dat_an2

# create individual ID
dat_an2$Individual_ID <- paste0(dat_an2$Datafile_ID, "_", dat_an2$Arena)
```

```{r 19_add_meta_make_trigrams, eval = FALSE}

#Movement analysis and session info merging.

# well_arena <- read_delim(here('Data', 'run_data', 'well_arena_corresp.csv'), delim = ';')

dat_an2 <- dat_an2 %>%
  left_join(Session_data, by = "Individual_ID")
  # mutate(Ymaze_arena = paste0(Plate, "_", Arena)) %>%
  # mutate(fly_id = paste(gsub('[A-Za-z0-9]+\\/([A-Za-z0-9_-]+)\\.csv', '\\1', data_files), arena, sep = "_"))
  # mutate(fly_id = paste0(Datafile_ID, "_", Ymaze_arena)) %>% # not really necessary
  # left_join(select(well_arena, Ymaze_arena, Plate48well), by = "Ymaze_arena") %>%
  # mutate(Individuals_ID_well = paste0(Individuals_ID, "_", Plate48well)) %>%
  # select(Datafile_ID, Individuals_ID, Individuals_ID_well, Ymaze_arena, time, Bin, Zone, t_zone)

# split datafile into individual flies
dat_an2 <- dat_an2 %>% split(., .[, "Individual_ID"])

dat_an2 <- dat_an2 %>%
  map(~ mutate(.x, Lag_zone = lag(Zone))) %>%
  map(~ mutate(.x, Turn = case_when(Lag_zone==1 & Zone==2 ~ 'L',
                                  Lag_zone==1 & Zone==3 ~ 'R',
                                  Lag_zone==2 & Zone==1 ~ 'R',
                                  Lag_zone==2 & Zone==3 ~ 'L',
                                  Lag_zone==3 & Zone==1 ~ 'L',
                                  Lag_zone==3 & Zone==2 ~ 'R',
                                  # lag_zone==zone ~ 'X', # this enables additional decision type = stay in the given zone
                                  TRUE ~ NA_character_ ))) %>%
  map(~ select(.x, Datafile_ID, Individual_ID, Arena, time, Bin, Zone, t_zone, Turn))

dat_an3 <- bind_rows(dat_an2)
dat_an3 <- dat_an3 %>%
  arrange(Datafile_ID, Individual_ID, Bin)

dat_an4 <- na.omit(dat_an3)
dat_an4
```

```{r 20_trigrams_cont, eval = FALSE}
dat_tri <- dat_an4 %>%
  group_by(Individual_ID)

dat_tri <- dat_tri %>%
  mutate(Trigram = str_c(Turn, lead(Turn), lead(Turn,2))) %>%
  ungroup() %>%
  select(Individual_ID, Turn, Trigram)
dat_tri
```

```{r 21_trigrams_summarise, eval = FALSE}
all_trigrams <- unique(dat_tri$Trigram)

tri_long <- dat_tri %>%
  select(-Turn) %>%
  na.omit() %>%
  group_by(Individual_ID) %>%
  table() %>%
  as_tibble() %>%
  arrange(Individual_ID)

tri_wide <- tri_long %>% pivot_wider(names_from = Trigram, values_from = n)

turn_long = dat_tri %>%
  select(-Trigram) %>%
  na.omit() %>%
  group_by(Individual_ID) %>%
  table() %>%
  as_tibble() %>%
  arrange(Individual_ID)

turn_wide <- turn_long %>% pivot_wider(names_from = Turn, values_from = n)

data_ymaze <- tri_wide %>%
  left_join(turn_wide, by = 'Individual_ID') %>%
  mutate(total_turns = L+R,
         reps = LLL + RRR,
         alter = RLR + LRL,
         partial = RRL + RLL + LRR + LLR,
         rel_reps = (reps*100)/total_turns,
         rel_alter = (alter*100)/total_turns,
         rel_R = (R*100)/total_turns,
         rel_L = (L*100)/total_turns,
         asymmetry = 1 - (R/L)) # 0 = symmetrical, <1 = 

data_ymaze
```

```{r 22_merge_session_data_ymaze, eval = FALSE}

data_ymaze <- data_ymaze %>%
  left_join(Session_data, by = "Individual_ID")

write.table(data_ymaze, "./data/data_ymaze.csv", sep = ",", row.names = F)
```

### Startle

```{r 23_load_data, eval = FALSE}
#specify directory of zantiks habituation files
data_path <- here("Data/habituation/") 

#create list of files from directory
file_list <- list.files(data_path)

#create header from first file
df <-
  paste(data_path, file_list[1],sep = '/') %>%
  read_csv(skip=4,col_names = TRUE, guess_max = 100) %>%
  head(0)

#create new list without demographic info
new_list<- c()

for (i in file_list){
  new_list[[i]] <-
    read_csv(paste(data_path, i, sep = '/'),
             skip=4, col_names = TRUE, guess_max = 100) %>%
    head(-1)
}

#append all files to df
for (i in new_list){
  df<-add_row(df,i)
}
```

```{r 24_select_variables, eval = FALSE}
df <- df %>% select(!c(RUNTIME, UNIT, TIMESLOT, TEMPERATURE))
#convert variables to factors for anova
df<-as_factor(df,BLOCK)
df<-as_factor(df,TYPE)

df <- df %>% rename(Datafile_ID = PLATE_ID, time_bin = TIME_BIN,
                    Block = BLOCK, Trial = TRIAL, Type = TYPE,
                    pre_post_counter = PRE_POST_COUNTER,
                    startle_number = STARTLE_NUMBER)

df <- df %>% select(-c(F6:F8), -c(F6MSD:F8MSD))
```

```{r 25_MSD_process_etal, eval = FALSE}
dfile_dist <- df %>% 
  select(!ends_with("MSD")) %>%
  gather(key = "Well", value = "distance", -Datafile_ID,
         -time_bin, -Block, -Trial, -Type, -pre_post_counter,
         -startle_number) %>%
  convert_as_factor(Well)

# create file with well factor and MSD activity dv only
dfile_act<- df %>%
  select(ends_with("MSD")) %>%
  gather(key = "Well", value = "activity") %>%
  convert_as_factor(Well)

# remove duplicate well variable before adding activity data
dfile_act <- select(dfile_act, -'Well')

# add activity column to rest of data
df <- add_column(dfile_dist, dfile_act)

# remove acclimation data
no_acclimation <- df %>%
  filter(Type != "ACCLIMATION")

# create data file with only startles from first repeat (Block == 1)
startles_only <- filter(no_acclimation, Type == "STARTLE", Block == 1)
# pop_startles_only<-filter(pop_data, Type == "STARTLE", Block == 1)
```

```{r 26_merge_with_session_data_startles, eval = FALSE}
# startles_only <- startles_only %>%
#     left_join(select(run_register, Datafile_ID, Individuals_ID, Exp_block, Batch_ID))

startles_only <- startles_only %>%
  mutate(Individual_ID = paste0(Datafile_ID, "_", Well))

startles_only <- startles_only %>%
  left_join(Session_data, by = "Individual_ID")
```

```{r 27_overall_summary, eval = FALSE}
startles_only <- startles_only %>%
  group_by(Individual_ID)

startles_only_act <- startles_only %>%
  filter(sum(distance) != 0) %>%
  ungroup()

overall_summary_act <- startles_only_act %>%
  group_by(startle_number) %>%
  get_summary_stats(distance, type = "mean_sd")

overall_summary <- startles_only %>%
  group_by(startle_number) %>%
  get_summary_stats(distance, type = "mean_sd")

binary_summary <- startles_only %>%
  group_by(Individual_ID) %>%
  summarise(startle_binary = ifelse(sum(distance) != 0, 1, 0))

startle_binary <- binary_summary %>%
  left_join(Session_data, by = 'Individual_ID')
  
write.table(startles_only, file = "./data/data_startle.csv", sep = ",", row.names = F)
write.table(startles_only_act, file = "./data/data_startle_act.csv", sep = ",", row.names = F)
write.table(startle_binary, file = "./data/data_startle_binary.csv", sep = ",", row.names = F)
```

## Assays assessed separately

Removing the individuals that got mixed up/went missing etc for the 'mean' response analysis
```{r 28_removing individuals}

data_locomotion$Exclude_mean <- as.factor(data_locomotion$Exclude_mean)

data_locomotion_reduced <- droplevels(data_locomotion[!data_locomotion$Exclude_mean == 'exclude',])

data_ymaze_reduced <- droplevels(data_ymaze[!data_ymaze$Exclude_mean == 'exclude',])

data_startle_act_reduced <- droplevels(data_startle_act[!data_startle_act$Exclude_mean == 'exclude',])


```

## Visualisations {.tabset}

*Treatment Codes*
I = isolated
GM = Group, mixed sex
GS = Group, single sex

### Locomotion 

Plotting average locomotion and individual differences
```{r 29_locomotion average effects, warning=FALSE}
data_locomotion_avg <-data_locomotion_reduced %>%
  group_by(Individual_ID) %>%
  summarise(avg = mean(arena_distance))

# raw data variation
plot1.1 <- data_locomotion_avg %>%
  ggplot(aes(x = avg)) +
  geom_histogram() +
  theme_classic() + theme(text = element_text(size = 15)) +
  xlab("Mean arena distance")
plot1.1
# log scale
plot1.2 <- data_locomotion_avg %>%
  ggplot(aes(x = log(avg+1))) +
  geom_histogram() +
  theme_classic() + theme(text = element_text(size = 15)) +
  xlab("log(Mean arena distance)") +
  ylab("Count")
plot1.2

plot1.3 <- data_locomotion_reduced %>%
  ggplot(aes(x = Individual_ID, y = log(arena_distance+1))) +
  geom_boxplot(width = 0, outlier.size = 0.7) +
  theme_classic() + theme(axis.text.x = element_blank()) +
  ylab("Arena distance") + xlab("Individuals")
plot1.3
```

Plotting treatment and sex effects

```{r 30_locomotion treatment and sex effects}

data_summary <- function(x) {
   m <- mean(x)
   ymin <- m-sd(x)
   ymax <- m+sd(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}

data_locomotion_reduced<-subset(data_locomotion_reduced, select = -Comment)
data_locomotion_reduced$Treatment<-as.factor(data_locomotion_reduced$Treatment)
data_locomotion_reduced$Sex<-as.factor(data_locomotion_reduced$Sex)

plot1.4 <- na.omit(data_locomotion_reduced) %>% 
  ggplot(aes(x = Treatment, y = log(arena_distance+1), fill = Sex)) + 
  geom_violin(position = position_dodge(1)) + stat_summary(fun.data=data_summary, position = position_dodge(1))  + labs(x = "Treatment", y = "log(Arena distance)")

plot1.4

```

### Ymaze

Distribution of trigrams

```{r 31_base_plots}

data_ymaze_reduced_long <- data_ymaze_reduced %>%
  pivot_longer(cols = c('LLL', 'LLR', 'LRL','LRR', 'RLL', 'RLR', 'RRL', 'RRR'), names_to = "Trigram", values_to = "Count")

plot2.1 <- data_ymaze_reduced_long %>%
  # filter(n > 0) %>%
  ggplot(aes(x = Trigram, y = Count)) +
  geom_col(position = "stack")+
  theme_classic() + labs(x = 'Trigram', y = 'Total count') +
  theme(legend.position = "none", text = element_text(size = 15))
plot2.1
```

General variation in repetition and alteration behaviour.

```{r 32_summary_histogram}

plot2.2 <- data_ymaze_reduced_long %>% pivot_longer(cols = c('reps', 'alter'), names_to = "Type", values_to = "Count_type") %>%
  ggplot(aes(x = Type, y = Count_type)) +
  geom_col(position = "stack") +
  theme_classic() + theme(text = element_text(size = 15)) +
  labs(x = "Repetitions vs Alternations", y = 'Count')
plot2.2
```

Treatment and Sex effects

```{r 33_base_plots}
data_ymaze_reduced_long$Treatment<-as.factor(data_ymaze_reduced_long$Treatment)

#males
plot2.3 <- data_ymaze_reduced_long %>%
  filter(Sex == "M") %>%
  ggplot(aes(x = Trigram, y = Count, fill = Treatment)) +
  geom_col() +
  ylim(0,7000) +
  theme_classic() + labs(x = 'Trigram', y = 'Total count', title = 'Males') +
  theme(text = element_text(size = 15), legend.position = "none") 

#females
plot2.4 <- data_ymaze_reduced_long %>%
  filter(Sex == "F") %>%
  ggplot(aes(x = Trigram, y = Count, fill = Treatment)) +
  geom_col()  +
  ylim(0,7000) +
  theme_classic() + labs(x = 'Trigram', y = 'Total count', title = 'Females') +
  theme( text = element_text(size = 15))
plot2.5 <- (plot2.3 + plot2.4)
plot2.5


data_ymaze_reduced_long2 <- data_ymaze_reduced_long %>% pivot_longer(
    cols = c('reps', 'alter'),
    names_to = "Type",
    values_to = "Count_type")

data_ymaze_reduced_long3 <- data_ymaze_reduced_long2 [c("Individual_ID", "Sex", "Type","Treatment", "Count_type")]

data_ymaze_reduced_long4 <- distinct(data_ymaze_reduced_long3)

data_summary <- function(x) {
   m <- mean(x)
   ymin <- m-sd(x)
   ymax <- m+sd(x)
   return(c(y=m,ymin=ymin,ymax=ymax))
}

data_ymaze_reduced_long4$Type<-as.factor(data_ymaze_reduced_long4$Type)
data_ymaze_reduced_long4$Sex<-as.factor(data_ymaze_reduced_long4$Sex)

#males
plot2.6 <- na.omit(data_ymaze_reduced_long4) %>% 
 filter(Sex == "M") %>%
  ggplot(aes(x = Treatment, y = Count_type, fill = Type)) + 
  geom_violin(position = position_dodge(1)) + stat_summary(fun.data=data_summary, position = position_dodge(1))  + labs(x = "Treatment", y = "Count_type") +
  ylim(0,200) +
  theme_classic() + theme(text = element_text(size = 15), legend.position = "none") +
  labs(x = "Treatment", y = 'Count', title = 'Males')


#females
plot2.7 <- na.omit(data_ymaze_reduced_long4) %>% 
 filter(Sex == "F") %>%
  ggplot(aes(x = Treatment, y = Count_type, fill = Type)) + 
  geom_violin(position = position_dodge(1)) + stat_summary(fun.data=data_summary, position = position_dodge(1))  + labs(x = "Treatment", y = "Count_type") +
  ylim(0,200) +
  theme_classic() + theme(text = element_text(size = 15)) +
  labs(x = "Treatment", y = 'Count', title = 'Females')

plot2.8 <- (plot2.6 + plot2.7)
plot2.8



plot2.9 <- na.omit(data_ymaze_reduced_long4) %>%
  filter(Sex == "M") %>%
  ggplot(aes(x = Treatment, y = Count_type, fill = Type)) + 
  geom_bar(position = "fill", stat = "identity")+
  theme_classic() + theme(text = element_text(size = 15), legend.position = "none") +
  labs(x = "Treatment", y = 'Count', title = 'Males')


plot2.10 <- na.omit(data_ymaze_reduced_long4) %>%
  filter(Sex == "F") %>%
  ggplot(aes(x = Treatment, y = Count_type, fill = Type)) + 
  geom_bar(position = "fill", stat = "identity")+
  theme_classic() + theme(text = element_text(size = 15)) +
  labs(x = "Treatment", y = 'Count', title = 'Females')

plot2.11 <- (plot2.9 + plot2.10)
plot2.11
 
#calculating percent scores

# plot2.6 <-
#   data_ymaze_reduced_long %>% pivot_longer(
#     cols = c('reps', 'alter'),
#     names_to = "Type",
#     values_to = "Count_type") %>%
#   filter(Sex == "M") %>%
#   ggplot(aes(x = Type, y = Count_type, fill = Treatment)) +
#   geom_col()  +
#   ylim(0,16000) +
#   theme_classic() + theme(text = element_text(size = 15), legend.position = "none") +
#   labs(x = "Repetitions vs Alternations", y = 'Count', title = 'Males')

# plot2.7 <-
#   data_ymaze_reduced_long %>% pivot_longer(
#     cols = c('reps', 'alter'),
#     names_to = "Type",
#     values_to = "Count_type") %>%
#   filter(Sex == "F") %>%
#   ggplot(aes(x = Type, y = Count_type, fill = Treatment)) +
#   geom_col()  +
#   ylim(0,16000) +
#   theme_classic() + theme(text = element_text(size = 15)) +
#   labs(x = "Repetitions vs Alternations", y = 'Count', title = 'Females')
# 
```

<!-- Treatment and sex within reps -->

``` {r}
# plot2.8 <- na.omit(data_ymaze_reduced_long) %>%
#   ggplot(aes(x = Sex, y = reps, fill = Treatment)) +
#   geom_bar(stat = "sum")+
#   theme_classic() + theme(text = element_text(size = 15)) +
#   labs( y = "Number of repetitions")
# plot2.8
# data_ymaze_reduced_long<-subset(data_ymaze_reduced_long, select = -Comment)
# 
# plot2.8 <- na.omit(data_ymaze_reduced_long) %>% 
#   ggplot(aes(x = Treatment, y = reps, fill = Sex)) + 
#   geom_violin(position = position_dodge(1)) + stat_summary(fun.data=data_summary, position = position_dodge(1))  + labs(x = "Treatment", y = "Number of reps") + theme_classic()
# 
# plot2.8

```

### Startle

```{r 34_base_plots}

data_startle_act_reduced<-subset(data_startle_act_reduced, select = -Comment)

#Average treatment and sex effects with each startle
#creating summary data of treatment and sex effects
data_startle_act_reduced$startle_number<- as.factor(data_startle_act_reduced$startle_number)
data_startle_act_reduced$Treatment<- as.factor(data_startle_act_reduced$Treatment)

g<-data_startle_act_reduced %>%
  group_by(Treatment,Sex, startle_number) %>%
  summarise(mean=mean(distance), sd = sd(distance))


plot3.1 <- na.omit(g) %>%
  filter(Sex == "M") %>%
  ggplot(aes(x = Treatment, y = mean, col = startle_number)) +
  geom_errorbar(aes(ymin = mean - (sd / sqrt(2)), ymax = mean + (sd / sqrt(2))),
                width = 1,
                position = position_dodge(1)) +
  geom_point(position = position_dodge(1)) + theme_classic() +
  ylim(-2, 10) + theme(text = element_text(size = 15), legend.position = "none") + labs(x = 'Treatment',
                                                              y = 'Total distance travelled',
                                                              col = "Startle number",
                                                              title = "Males")


plot3.2<- na.omit(g) %>%
  filter(Sex == "F") %>%
  ggplot(aes(x = Treatment, y = mean, col = startle_number)) +
  geom_errorbar(aes(ymin = mean - (sd / sqrt(2)), ymax = mean + (sd / sqrt(2))),
                width = 1,
                position = position_dodge(1)) +
  geom_point(position = position_dodge(1)) + theme_classic() +
  ylim(-2, 10) +
  theme(text = element_text(size = 15)) + labs(x = 'Treatment',
                                               y = 'Total distance travelled',
                                               col = "Startle number",
                                               title = "Females")



plot3.3 <- (plot3.1 + plot3.2)
plot3.3

# habituation data by individual - only active flies
data_startle_act_reduced$startle_number<- as.integer(data_startle_act_reduced$startle_number)
plot3.4 <- ggplot(data=data_startle_act_reduced, aes(x = startle_number, y = distance)) +
  facet_wrap(facets = ~ Individual_ID) +
  geom_line() +
  geom_point() + theme_bw() +
  scale_x_continuous(breaks = c(1,2,3)) +
  scale_y_continuous(breaks = c(10, 30)) +
  theme(strip.text.x = element_blank(), text = element_text(size = 15)) +
  labs(x = 'Startle number', y = 'Total distance travelled')
plot3.4
```

## Mean models {.tabset}

### Locomotion

```{r locomotion mean effect}

m <- lmer(log(arena_distance+1) ~ Treatment*Sex + (1|Individual_ID) + (1|Batch), dat = data_locomotion_reduced)

summary(m)
#males for active than females, no effect of treatment

qplot(residuals(m)) + theme_classic()


#sex specific between individual variation
m2 <- lmer(log(arena_distance+1) ~ Treatment*Sex + (Sex|Individual_ID) + (1|Batch), dat = data_locomotion_reduced)
#warning message about convergence
summary(m2)

anova(m, m2) %>% kbl() %>% kable_material(c("striped"))

```

###  Ymaze

```{r ymaze mean effect}
# model: variance between rounds, individuals and batches, fixed effect of sex and assay date
# data_ymaze_reduced_long2 <- data_ymaze_reduced_long %>% pivot_longer(cols = c('reps', 'alter'), names_to = "Type", values_to = "Count_type")


m3 <-glmer(alter~ Sex*Treatment + (1|Individual_ID) + (1|Batch), family = poisson, data = data_ymaze_reduced_long)
summary(m3)

# this requires "car" pacakge
Anova(m3, test  = "Chisq")

m4 <-glmer(reps~ Sex*Treatment + (1|Individual_ID) + (1|Batch), family = poisson, data = data_ymaze_reduced_long)
summary(m4)

# TODO adding models to see hidden contrasts
#need to run m3 and m3a to get all contrasts
m3a <-glmer(alter~ Sex*relevel(factor(Treatment), ref = "GS") + (1|Individual_ID) + (1|Batch), family = poisson, data = data_ymaze_reduced_long)
summary(m3a)

```

### Startle

```{r startle mean effect}
m5 <- lmer(distance ~ Sex*Treatment + (1|Batch) + (startle_number|Individual_ID),
               data = data_startle_act_reduced)
#boundary fit is singular
summary(m5)
```

Looking if the slopes with each startle differ between startle 

```{r startle mean effect_slope}

m6 <- lmer(distance ~ Sex*Treatment + Sex*startle_number + (1|Batch) + (1|Individual_ID), data = data_startle_act_reduced)

summary(m6) #significant interaction with sex and startle number

anova(m6)

qplot(residuals(m6)) + theme_classic()

```

## Correlations Visualisations

### Locomotion and ymaze

```{r joining loco ymaze}
data_loco_ymaze <- left_join(data_locomotion_reduced, data_ymaze_reduced_long, by = 'ID') %>% 
  select(ID, arena_distance, reps, alter, partial, Sex.x, Treatment.x) %>%
  group_by(ID) %>%
  mutate(avg_loco = mean(arena_distance)) %>%
  select(ID, reps, alter, partial, Sex.x, Treatment.x, avg_loco) %>%
 distinct()
```

#### Reps

```{r locomotion_reps}
#not including treatment as there was no effect of treatment on

#TODO check if we need to remove any individuals 
p1a <- ggplot(na.omit(data_loco_ymaze), x = reps, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x) +
  geom_point(aes(x = reps, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = reps, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) +
  theme_classic()


# just sex
p1b <- ggplot(na.omit(data_loco_ymaze), x = reps, y = log(avg_loco+1), shape = Sex.x) +
  geom_point(aes(x = reps, y = log(avg_loco+1), shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = reps, y = log(avg_loco+1), 
                               shape = Sex.x))+
  theme_classic()

# just treatment

p1c <- ggplot(na.omit(data_loco_ymaze), x = reps, y = log(avg_loco+1), color = Treatment.x) +
  geom_point(aes(x = reps, y = log(avg_loco+1), color = Treatment.x)) + 
  geom_smooth(method = lm, aes(x = reps, y = log(avg_loco+1), color = Treatment.x))+
  theme_classic()

p1 <- (p1a/p1b/p1c)
p1
```

#### Alters

```{r locomotion_alters}
#not including treatment as there was no effect of treatment on

#TODO check if we need to remove any individuals 
p2a <- ggplot(na.omit(data_loco_ymaze), x = alter, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x) +
  geom_point(aes(x = alter, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = alter, y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) +
  theme_classic()


# just sex
p2b <- ggplot(na.omit(data_loco_ymaze), x = alter, y = log(avg_loco+1), shape = Sex.x) +
  geom_point(aes(x = alter, y = log(avg_loco+1), shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = alter, y = log(avg_loco+1), 
                               shape = Sex.x))+
  theme_classic()

# just treatment
p2c <- ggplot(na.omit(data_loco_ymaze), x = alter, y = log(avg_loco+1), color = Treatment.x) +
  geom_point(aes(x = alter, y = log(avg_loco+1), color = Treatment.x)) + 
  geom_smooth(method = lm, aes(x = alter, y = log(avg_loco+1), color = Treatment.x))+
  theme_classic()

p2 <- (p2a/p2b/p2c)
p2
```

### Locomotion and Startle

```{r joining loco startle}
data_loco_startle <- left_join(data_locomotion_reduced, data_startle_act_reduced, by = 'ID') %>% 
  select(ID, startle_number, distance, arena_distance, Sex.x, Treatment.x) %>%
  group_by(ID) %>%
  mutate(avg_startle = mean(distance)) %>%
  mutate(avg_loco = mean(arena_distance)) %>%
  ungroup() %>%
  select(ID, Sex.x, Treatment.x, avg_startle, avg_loco) %>%
  distinct()

#note that there is much lower cross over between individuals with both loco and habituation observations

#TODO adding this

cor.test(data_loco_startle$avg_startle, data_loco_startle$avg_loco)
  
```

```{r loco startle}
p3a <- ggplot(na.omit(data_loco_startle), x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x, shape = Sex.x) +
  geom_point(aes(x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x, shape = Sex.x)) +
  theme_classic()

#just Sex
p3b <- ggplot(na.omit(data_loco_startle), x = log(avg_startle), y = log(avg_loco+1), shape = Sex.x) +
  geom_point(aes(x = log(avg_startle), y = log(avg_loco+1), shape = Sex.x)) + 
  geom_smooth(method = lm, aes(x = log(avg_startle), y = log(avg_loco+1), shape = Sex.x)) +
  theme_classic()

#just treatment
p3c <- ggplot(na.omit(data_loco_startle), x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x) +
  geom_point(aes(x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x)) + 
  geom_smooth(method = lm, aes(x = log(avg_startle), y = log(avg_loco+1), color = Treatment.x)) +
  theme_classic()

p3 <- (p3a/p3b/p3c)
p3

```
